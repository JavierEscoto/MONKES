 In this section we describe the algorithm to numerically solve the drift-kinetic equation (\ref{eq:DKE}) and its implementation. The algorithm, based on the tridiagonal representation of the drift-kinetic equation, emerges naturally when the velocity coordinate $\xi$ is discretized using a Legendre spectral method.
 
 First, in subsection \ref{subsec:Legendre_expansion} we will present the algorithm in a formal way. We will use (right-handed) Boozer coordinates\footnote{Even though we use Boozer coordinates, we want to stress out that the algorithm presented in subsection \ref{subsec:Legendre_expansion} is valid for any set of spatial coordinates in which $\psi$ labels flux-surfaces and the two remaining coordinates parametrize the flux-surface.} $(\psi,\theta,\zeta)\in[0,\psi_{\text{lcfs}}]\times[0,2\pi)\times[0,2\pi/N_p)$. The integer $N_p\ge 1$ denotes the number of toroidal periods of the device. The radial coordinate is selected so that $2\pi \psi$ is the toroidal flux of the magnetic field and $\theta$, $\zeta$ are respectively the poloidal and toroidal (in a single period) angles. In these coordinates, the magnetic field can be written as
 \begin{align}
 	\vb*{B} & = \nabla\psi \times \nabla\theta - \iota(\psi) \nabla\psi \times \nabla\zeta 
 	\nonumber\\
 	& = B_\psi(\psi,\theta,\zeta) \nabla \psi + B_\theta(\psi) \nabla \theta + B_\zeta(\psi) \nabla \zeta,
 	\label{eq:Magnetic_field_Boozer}
 \end{align}
 and the Jacobian of the transformation reads 
 %
 \begin{align}
 	\sqrt{g}(\psi,\theta,\zeta) 
 	:=( 
 	\nabla\psi \times \nabla \theta \cdot \nabla\zeta  
 	)^{-1} 
 	= 
 	\frac{B_\zeta + \iota B_\theta}{B^2},
 	\label{eq:Jacobian_Boozer}
 \end{align} 
 where $\iota :=\vb*{B} \cdot \nabla \theta / \vb*{B} \cdot \nabla \zeta $ is the rotational transform. The flux-surface average operation (\ref{eq:FSA}) is written in Boozer angles as
 %
 \begin{align}
 	\mean*{f}
 	=
 	\left(\dv{V}{\psi}\right)^{-1}
 	\oint\oint
 	f
 	\sqrt{g}
 	\dd{\theta}\dd{\zeta}
 	.
 	\label{eq:FSA_Boozer}
 \end{align}
 
 We define the reference value for the magnetic field strength $B_0$ introduced in definition (\ref{eq:Parallel_flow_Original}) as the $(0,0)$ Fourier mode of the magnetic field strength. Namely, 
 %
 \begin{align}
 	B_0(\psi) := \frac{N_p}{4\pi^2 } 
 	\oint\oint
 	B(\psi,\theta,\zeta)
 	\dd{\theta}\dd{\zeta}.
 \end{align}
 
 Using (\ref{eq:Magnetic_field_Boozer}) and (\ref{eq:Jacobian_Boozer}), the spatial differential operators present in the drift-kinetic equation (\ref{eq:DKE}) can be expressed in these coordinates as
 %
 \begin{align}
 	\vb*{b} \cdot \nabla & = 
 	\frac{B}{B_\zeta + \iota B_\theta}
 	\left(
 	\iota \pdv{\theta}
 	+ 
 	\pdv{\zeta} 
 	\right), \label{eq:Parallel_streaming_spatial_operator}
 	\\
 	\vb*{B}\times\nabla\psi \cdot \nabla & = 
 	\frac{B^2}{B_\zeta + \iota B_\theta}
 	\left(
 	B_\zeta \pdv{\theta}
 	-
 	B_\theta \pdv{\zeta}
 	\right). \label{eq:ExB_spatial_operator}
 \end{align}
  
 
 
 
 After the explanation of the algorithm, in subsection \ref{subsec:Algorithm_Implementation} its implementation in {\MONKES} is described. In order to ease the notation, in subsections \ref{subsec:Legendre_expansion} and \ref{subsec:Algorithm_Implementation} we drop when possible the subscript $j$ that labels every different source term.  Also, as $\psi$ and $v$ act as mere parameters, we will omit their dependence and functions of these two variables will be referred to as constants. 
 
 \subsection{Legendre polynomial expansion}\label{subsec:Legendre_expansion}
 The algorithm is based on the approximate representation of the distribution function $f$ by a truncated Legendre series. We will search for approximate solutions to equation (\ref{eq:DKE}) of the form
 %
 \begin{align}
 	f(\theta,\zeta,\xi) = \sum_{k=0}^{N_\xi} f^{(k)}(\theta,\zeta) P_k(\xi), \label{eq:Legendre_expansion}
 \end{align} 
where $f^{(k)} = \mean*{f,P_k}_\Lorentz / \mean*{P_k,P_k}_\Lorentz$ is the $k-$th Legendre mode of $f(\theta,\zeta,\xi)$ (see \ref{sec:Appendix_Legendre}) and $N_\xi$ is an integer greater or equal to 1. As mentioned in \ref{sec:Appendix_Legendre}, the expansion in Legendre polynomials (\ref{eq:Legendre_expansion}) ensures that the regularity conditions (\ref{eq:Regularity_conditions}) are satisfied. Of course, in general, the exact solution to equation (\ref{eq:DKE}) does not have a finite Legendre spectrum, but taking $N_\xi$ sufficiently high in expansion (\ref{eq:Legendre_expansion}) yields an approximate solution to the desired degree of accuracy (in infinite precision arithmetic).  

  
 In \ref{sec:Appendix_Legendre} we derive explicitly the projection of each term of the drift-kinetic equation (\ref{eq:DKE}) onto the Legendre basis when the representation (\ref{eq:Legendre_expansion}) is used. When doing so, we obtain that the Legendre modes of the drift-kinetic equation have the tridiagonal representation  
 %
 \begin{align}
 	L_k f^{(k-1)} + D_k f^{(k)} + U_k f^{(k+1)} = s^{(k)},  
 	\label{eq:DKE_Legendre_expansion}
 \end{align}
 for $k=0,1,\ldots ,N_\xi$, where we have defined for convenience $f^{(-1)}:=0$ and from expansion (\ref{eq:Legendre_expansion}) it is clear that $f^{(N_\xi+1)}=0$. Analogously to (\ref{eq:Legendre_expansion}) the source term is expanded as $s=\sum_{k=0}^{N_\xi} s^{(k)} P_k$. For the sources given by (\ref{eq:DKE_Sources}) this expansion is exact when $N_\xi\ge2$ as $s_j^{(k)}=0$ for $k\ge 3$. The spatial differential operators read 
 %
 \begin{align}
 	L_k & = 
 	\frac{k}{2k-1} 
 	\left(
 	\vb*{b} \cdot \nabla 
 	+
 	\frac{k-1}{2}
 	\vb*{b}\cdot\nabla \ln B
 	\right), \label{eq:DKE_Legendre_expansion_Lower}
 	\\ 
 	D_k & = - 
 	\frac{\hat{E}_\psi}{\mean*{B^2}}
 	\vb*{B}\times \nabla\psi  \cdot \nabla 
 	+  
 	\frac{k(k+1)}{2}
 	\hat{\nu} , \label{eq:DKE_Legendre_expansion_Diagonal}
 	\\
 	U_k & =  
 	\frac{k+1}{2k+3} 
 	\left(
 	\vb*{b} \cdot \nabla 
 	-
 	\frac{k+2}{2}
 	\vb*{b}\cdot\nabla \ln B
 	\right). \label{eq:DKE_Legendre_expansion_Upper}
 \end{align}
Thanks to its tridiagonal structure, the system of equations (\ref{eq:DKE_Legendre_expansion}) can be inverted using the standard Gaussian elimination algorithm for block tridiagonal matrices. 


Before introducing the algorithm we will explain how to fix the free constant of the solution to equation (\ref{eq:DKE_Legendre_expansion}) so that it can be inverted. Note that the aforementioned kernel of the drift-kinetic equation translates in the fact that $f^{(0)}$ is not completely determined from equation (\ref{eq:DKE_Legendre_expansion}). To prove this, we inspect the modes $k=0$ and $k=1$ of equation (\ref{eq:DKE_Legendre_expansion}), which are the ones that involve $f^{(0)}$. From expression (\ref{eq:ExB_spatial_operator}) we can deduce that the term $D_0 f^{(0)} + U_0 f^{(1)} $ is invariant if we add to $f^{(0)}$ any function of $B_\theta \theta + B_\zeta  \zeta$. For $\hat{E}_\psi\ne 0$, functions of $B_\theta \theta + B_\zeta  \zeta$ lie on the kernel of $\vb*{B}\times\nabla \psi \cdot \nabla$ and for $\hat{E}_\psi = 0$, $D_0$ is identically zero. Besides, the term $L_1 f^{(0)} + D_1 f^{(1)} + U_1 f^{(2)}$ remains invariant if we add to $f^{(0)} $ any function of $\theta-\iota\zeta$ (the kernel of $L_1=\vb*{b}\cdot\nabla$ consists of these functions). However, for ergodic flux-surfaces the only continuous functions on the torus that belong to the kernel of $L_1$ are constants. Thus, equation (\ref{eq:DKE_Legendre_expansion}) is unaltered when we add to $f^{(0)}$ any constant (a function that belongs simultaneously to the kernels of $\vb*{B}\times\nabla \psi \cdot \nabla$ and $\vb*{b}\cdot\nabla$). A constraint equivalent to condition (\ref{eq:kernel_elimination_condition}) is to fix the value of the $0-$th Legendre mode of the distribution function at a single point of the flux-surface. For example,
 %
 \begin{align}
 	f^{(0)}(0,0)=0, \label{eq:kernel_elimination_condition_Legendre}
 \end{align}
which implicitly fixes the value of the constant $C$ in (\ref{eq:kernel_elimination_condition}).
 With this condition, equation (\ref{eq:DKE_Legendre_expansion}) has a unique solution and its left-hand-side can be inverted (further details on its invertibility are given in \ref{sec:Appendix_Invertibility}) to solve for $f^{(k)}$. Note that, as expansion (\ref{eq:Legendre_expansion}) is finite and representation (\ref{eq:DKE_Legendre_expansion}) is non diagonal, the functions $f^{(k)}$ obtained from inverting (\ref{eq:DKE_Legendre_expansion}) constrained by (\ref{eq:kernel_elimination_condition_Legendre}) are approximations to the first $N_\xi+1$ Legendre modes of the exact solution to (\ref{eq:DKE}) satisfying (\ref{eq:kernel_elimination_condition}) (further details at the end of \ref{sec:Appendix_Legendre}).
 
 The algorithm for solving the truncated drift-kinetic equation (\ref{eq:DKE_Legendre_expansion}) consists of two steps. 
 \begin{enumerate}
 	\item \textbf{Forward elimination}
 \end{enumerate} 	
 Starting from $\Delta_{N_\xi} = D_{N_\xi}$ and $\sigma^{(N_\xi)} = s^{(N_\xi)}$ we can obtain recursively the operators
 %
 \begin{align}
 	\Delta_k = D_k - U_{k} \Delta_{k+1}^{-1} L_{k+1}, 
 	\label{eq:Schur_complements}
 \end{align} 
 and the sources
 %
 \begin{align}
 	\sigma^{(k)} = s^{(k)} - U_k \Delta_{k+1}^{-1}    \sigma^{(k+1)},
 	\label{eq:Forward_elimination_sources}
 \end{align}
 for $k=N_\xi-1, N_\xi-2, \ldots, 0$ (in this order). Equations (\ref{eq:Schur_complements}) and (\ref{eq:Forward_elimination_sources}) define the forward elimination. With this procedure we can transform equation (\ref{eq:DKE_Legendre_expansion}) to the equivalent system
 %
 \begin{align}
 	L_{k} f^{(k-1)} + \Delta_{k} f^{(k)} = \sigma^{(k)},
 	\label{eq:DKE_Forward_elimination}
 \end{align}
 for $k=0,1, \ldots, N_\xi$. Note that this process corresponds to perform formal Gaussian elimination over 
  %
  \begin{align}
  	\Matrix{ccc|c}
  	{
  		L_{k} & D_{k} & U_k  & s^{(k)} \\
  		0& L_{k+1} & \Delta_{k+1}  & \sigma^{(k+1)} \\
  	}
%  	\Matrix{c}{f^{(k-1)} \\ f^{(k)} \\ f^{(k+1)} }
%  	=
%  	\Matrix{c}
%  	{s^{(k)} \\ \sigma^{(k+1)}}
  	,
%  	\sim
%	\Matrix{ccc}
%	{
%		L_{k} & \Delta_{k} & 0  \\
%		0& L_{k+1} & \Delta_{k+1}  \\
%	}
%	\Matrix{c}{f^{(k-1)} \\ f^{(k)} \\ f^{(k+1)} }
%	=
%	\Matrix{c}{\sigma^{(k)} \\ \sigma^{(k+1)}}
	\label{eq:DKE_Forward_Elimination}
  \end{align}
  to eliminate $U_k$ in the first row.
  
  \begin{enumerate}[resume]
   \item \textbf{Backward substitution}
\end{enumerate}
   Once we have the system of equations in the form (\ref{eq:DKE_Forward_elimination}) it is immediate to solve recursively
   %
   \begin{align}
   	f^{(k)} = 
   	\Delta_k^{-1}
   	\left( 
   	\sigma^{(k)} -  L_{k} f^{(k-1)} 
   	\right), 	\label{eq:DKE_Backward_Substitution}
   \end{align}
   for $k=0,1,...,N_\xi$ (in this order). Here, $\Delta_0^{-1} \sigma^{(0)}$ denotes the unique solution to $\Delta_0 f^{(0)} = \sigma^{(0)} $ that satisfies (\ref{eq:kernel_elimination_condition_Legendre}). As $L_1= \vb*{b}\cdot \nabla$, using expression (\ref{eq:Parallel_streaming_spatial_operator}), it is clear from equation (\ref{eq:DKE_Backward_Substitution}) that the integration constant does not affect the value of $f^{(1)}$.
%\end{enumerate}

 We can apply this algorithm to solve equation (\ref{eq:DKE}) for $f_1$, $f_2$ and $f_3$ in order to compute approximations to the transport coefficients. In terms of the Legendre modes of $f_1$, $f_2$ and $f_3$, the monoenergetic geometric coefficients from definition (\ref{eq:Monoenergetic_geometric_coefficients}) read
 %
 \begin{align}
 	\widehat{D}_{11} & = 2\mean*{s_1^{(0)} f_1^{(0)}} + \frac{2}{5}\mean*{s_1^{(2)} f_1^{(2)}}, 
 	\label{eq:Gamma_11_Legendre}\\ 
 	\widehat{D}_{31} & = \frac{2}{3} \mean*{\frac{B}{B_0} f_1^{(1)}},\label{eq:Gamma_31_Legendre}\\ 
 	\widehat{D}_{13} & = 2\mean*{s_1^{(0)} f_3^{(0)}} + \frac{2}{5}\mean*{s_1^{(2)} f_3^{(2)}}, \label{eq:Gamma_13_Legendre}\\ 
 	\widehat{D}_{33} & =\frac{2}{3} \mean*{\frac{B}{B_0} f_3^{(1)}}, \label{eq:Gamma_33_Legendre}
 \end{align}
 where $3s_1^{(0)} /2= 3s_1^{(2)} = \vb*{B}\times\nabla\psi \cdot \nabla B / B^3$. Note  from expressions (\ref{eq:Gamma_11_Legendre}), (\ref{eq:Gamma_31_Legendre}), (\ref{eq:Gamma_13_Legendre}) and (\ref{eq:Gamma_33_Legendre}) that, in order to compute the monoenergetic geometric coefficients $\widehat{D}_{ij}$, we only need to calculate the Legendre modes $k=0,1,2$ of the solution and we can stop the backward substitution (\ref{eq:DKE_Backward_Substitution}) at $k=2$. In the next subsection we will explain how {\MONKES} solves equation (\ref{eq:DKE_Legendre_expansion}) using this algorithm.
 
 
 
 \subsection{Spatial discretization and algorithm implementation}\label{subsec:Algorithm_Implementation}
 The algorithm described above allows, in principle, to compute the exact solution to the truncated drift-kinetic equation (\ref{eq:DKE_Legendre_expansion}) which is an approximate solution to (\ref{eq:DKE}). However, to our knowledge, it is not possible to give an exact expression for the operator $\Delta_k^{-1}$ except for $k=N_\xi \ge 1$. Instead, we are forced to compute an approximate solution to (\ref{eq:DKE_Legendre_expansion}).
 In order to obtain an approximate solution of equation (\ref{eq:DKE_Legendre_expansion}) we assume that each $f^{(k)}$ has a finite Fourier spectrum so that it can be expressed as
\begin{align}	
	f^{(k)}(\theta,\zeta)
	& 
	=
	\vb*{I}(\theta,\zeta)
	\cdot
	\vb*{f}^{(k)},
	\label{eq:Fourier_expansion_f_k}
\end{align}
where the Fourier interpolant row vector map $\vb*{I}(\theta,\zeta)$ is defined at \ref{sec:Appendix_Fourier} and the column vector $\vb*{f}^{(k)}\in\mathbb{R}^{N_{\text{fs}}}$
contains $f^{(k)}$ evaluated at the equispaced grid points
%
\begin{align}
	\theta_i & = 2\pi i / N_\theta, \quad & i=0,1,\ldots, N_\theta-1,  \label{eq:Theta_grid}
	\\ 
	\zeta_j & = 2\pi j / (N_\zeta N_p), \quad & j=0,1,\ldots, N_\zeta-1. \label{eq:Zeta_grid}
\end{align}
Here, $N_{\text{fs}}:=N_\theta N_\zeta$ is the number of points in which we discretize the flux-surface being $N_\theta$ and $N_\zeta$ respectively the number of points in which we divide the domains of $\theta$ and $\zeta$. In general, the solution to equation (\ref{eq:DKE_Legendre_expansion}) has an infinite Fourier spectrum and cannot exactly be written as (\ref{eq:Fourier_expansion_f_k}) but, taking sufficiently large values of $N_\theta$ and $N_\zeta$, we can approximate the solution to equation (\ref{eq:DKE_Legendre_expansion}) to arbitrary degree of accuracy (in infinite precision arithmetic). As explained in \ref{sec:Appendix_Fourier}, introducing the Fourier interpolant (\ref{eq:Fourier_expansion_f_k}) in equation (\ref{eq:DKE_Legendre_expansion}) and then evaluating the result at the grid points provides a system of $N_{\text{fs}}\times(N_\xi+1)$ equations which can be solved for $\{\vb*{f}^{(k)}\}_{k=0}^{N_\xi}$. This system of equations is obtained by substituting the operators $L_k$, $D_k$, $U_k$ in equation (\ref{eq:DKE_Legendre_expansion}) by the $N_{\text{fs}}\times N_{\text{fs}}$ matrices $\vb*{L}_k$, $\vb*{D}_k$, $\vb*{U}_k$, defined in \ref{sec:Appendix_Fourier}. Thus, we discretize (\ref{eq:DKE_Legendre_expansion}) as %
\begin{align}
	\vb*{L}_k  \vb*{f}^{(k-1)} + \vb*{D}_k  \vb*{f}^{(k)} + \vb*{U}_k   \vb*{f}^{(k+1)} = \vb*{s}^{(k)},   \label{eq:DKE_Legendre_expansion_Fourier_collocation}
\end{align}
for $k=0,1\ldots, N_\xi$ where $\vb*{s}^{(k)}\in\mathbb{R}^{N_{\text{fs}}}$
contains $s^{(k)}$ evaluated at the equispaced grid points. This system has a block tridiagonal structure and the algorithm presented in subsection \ref{subsec:Legendre_expansion} can be applied. We just have to replace in equations (\ref{eq:Schur_complements}), (\ref{eq:Forward_elimination_sources}) and (\ref{eq:DKE_Backward_Substitution}) the operators and functions by their respective matrix and vector analogues, which we denote by boldface letters. 

The matrix approximation to the forward elimination procedure given by equations (\ref{eq:Schur_complements}) and (\ref{eq:Forward_elimination_sources}) reads
 %
\begin{align}
	\vb*{\Delta}_k & = \vb*{D}_k - \vb*{U}_{k} \vb*{\Delta}_{k+1}^{-1} \vb*{L}_{k+1}, 
	\label{eq:Schur_complements_matrix}
	\\
	\vb*{\sigma}^{(k)} & = \vb*{s}^{(k)} - \vb*{U}_{k}  \vb*{\Delta}_{k+1}^{-1}    \vb*{\sigma}^{(k+1)},
	\label{eq:Forward_elimination_sources_matrix}
\end{align}
for $k=N_\xi-1, N_\xi-2, \ldots, 0$ (in this order). Thus, starting from $\vb*{\Delta}_{N_\xi}=\vb*{D}_{N_\xi}$ and $\vb*{\sigma}^{(N_\xi)}=\vb*{s}^{(N_\xi)}$ all the matrices $\vb*{\Delta}_k$ and the vectors $\vb*{\sigma}^{(k)}$ are defined from equations (\ref{eq:Schur_complements_matrix}) and (\ref{eq:Forward_elimination_sources_matrix}). Obtaining the matrix $\vb*{\Delta}_k$ from directly applying equation (\ref{eq:Schur_complements_matrix}) requires to invert $\vb*{\Delta}_{k+1}$, perform two matrix multiplications and a subtraction of matrices. The inversion using LU factorization and each matrix multiplication require $O(N_{\text{fs}}^3)$ operations so it is desirable to reduce the number of matrix multiplications as much as possible. We can reduce the number of matrix multiplications in determining $\vb*{\Delta}_{k}$ to one if instead of computing $\vb*{\Delta}_{k+1}^{-1}$ we solve the matrix system of equations
%
\begin{align}
	\vb*{\Delta}_{k+1} \vb*{X}_{k+1} = \vb*{L}_{k+1},
	\label{eq:Forward_elimination_X}  
\end{align}
for $\vb*{X}_{k+1}$ and then obtain 
%
\begin{align}
	\vb*{\Delta}_k = \vb*{D}_k - \vb*{U}_{k}\vb*{X}_{k+1}, 
	\label{eq:Schur_complements_Fourier_collocation}
\end{align}
for $k=N_\xi-1, N_\xi-2, \ldots, 0$. Thus, for obtaining $\vb*{\Delta}_k$ we require $O(N_{\text{fs}}^3)$ operations for solving equation (\ref{eq:Forward_elimination_X}) and also for applying (\ref{eq:Schur_complements_Fourier_collocation}). For $k\le 1$ as we need to solve equation (\ref{eq:DKE_Forward_elimination}), which is equivalent to applying the backward substitution (\ref{eq:DKE_Backward_Substitution}), it is convenient to store $\vb*{\Delta}_{k+1}$ in factorized LU form. The matrix $\vb*{\Delta}_{0}$ will be factorized later, during the backward substitution step.
	
Similarly to what is done to obtain $\vb*{\Delta}_k$, to compute $\vb*{\sigma}^{(k)}$ we first solve 
%
\begin{align}
	\vb*{\Delta}_{k+1} \vb*{y} = \vb*{\sigma}^{(k+1)}
	\label{eq:Forward_elimination_matrix_y_system}
\end{align}
for $\vb*{y}$ and then compute
%
\begin{align}
	\vb*{\sigma}^{(k)} & = \vb*{s}^{(k)} - \vb*{U}_{k}  \vb*{y},
	\label{eq:Forward_elimination_sources_matrix_y}
\end{align}
%
for $k\ge 0$. As $\vb*{\Delta}_{k+1}$ is already LU factorized, solving equation (\ref{eq:Forward_elimination_matrix_y_system}) and then applying (\ref{eq:Forward_elimination_sources_matrix_y}) requires $O(N_{\text{fs}}^2)$ operations and its contribution to the arithmetic complexity of the algorithm is subdominant with respect to the $O(N_{\text{fs}}^3)$ operations required to compute $\vb*{\Delta}_k$. Nevertheless, recall that none of the source terms $s_1$, $s_2$ and $s_3$ defined by (\ref{eq:DKE_Sources}) have Legendre modes greater than 2. Specifically, equation (\ref{eq:Forward_elimination_sources_matrix}) implies $\vb*{\sigma}_1^{(k)}, \vb*{\sigma}_3^{(k-1)} = 0$ for $k\ge 3$ and also $\vb*{\sigma}_1^{(2)} = \vb*{s}_1^{(2)}$, $\vb*{\sigma}_3^{(1)} = \vb*{s}_3^{(1)}$. Thus, we only have to solve equation (\ref{eq:Forward_elimination_matrix_y_system}) and apply (\ref{eq:Forward_elimination_sources_matrix_y}) to obtain $\{\vb*{\sigma}_1^{(k)}\}_{k=0}^{1}$ and $\vb*{\sigma}_3^{(0)}$.

For the backward substitution, we first note that solving the matrix version of equation (\ref{eq:DKE_Forward_elimination}) to obtain $\vb*{f}^{(0)}$ requires $O(N_{\text{fs}}^3)$ operations, as $\vb*{\Delta}_0$ has not been LU factorized during the forward elimination. On the other hand, obtaining the remaining modes  $\{\vb*{f}^{(k)}\}_{k=1}^{2}$, requires $O(N_{\text{fs}}^2)$ operations. As the resolution of the matrix system of equations (\ref{eq:Forward_elimination_X}) and the matrix multiplication in (\ref{eq:Schur_complements_Fourier_collocation}) must be done $N_\xi$ times, solving equation (\ref{eq:DKE_Legendre_expansion_Fourier_collocation}) by this method requires $O(N_\xi N_{\text{fs}}^3)$ operations. 

In what concerns to memory resources, as we are only interested in the Legendre modes $0$, $1$ and $2$, it is not necessary to store in memory all the matrices $\vb*{L}_k$, $\vb*{D}_k$, $\vb*{U}_k$ and $\vb*{\Delta}_k$. Instead, we store solely $\vb*{L}_k$, $\vb*{U}_k$ and $\vb*{\Delta}_k$ (in LU form) for $k=0,1,2$. For the intermediate steps we just need to use some auxiliary matrices $\vb*{L}$, $\vb*{D}$, $\vb*{U}$, $\vb*{\Delta}$ and $\vb*{X}$ of size $N_{\text{fs}}$. This makes the amount of memory required by {\MONKES} independent of $N_\xi$, being of order $N_{\text{fs}}^2$.
\begin{algorithm}
	\caption{Block tridiagonal solution algorithm implemented in {\MONKES}.}\label{alg:MONKES_BTD}		
	\textbf{1. Forward elimination:}
	\begin{algorithmic}%[1]
		\State{
			$\vb*{L}\gets \vb*{L}_{N_\xi}$} \Comment{Starting value for $\vb*{L}$}
		\State{$\vb*{\Delta}\gets \vb*{D}_{N_\xi}$} \Comment{Starting value for $\vb*{\Delta}$} 
		\State{Solve $\vb*{\Delta} \vb*{X}=\vb*{L}$} \Comment{Compute $\vb*{X}_{N_\xi}$ stored in $\vb*{X}$}
		
		\For{$k=N_\xi-1$ \textbf{to} $0$}
		\State{$\vb*{L}\gets \vb*{L}_{k}$} 
		\Comment{Construct $\vb*{L}_k$ stored in $\vb*{L}$}
		\State{$\vb*{D}\gets \vb*{D}_{k}$} 
		\Comment{Construct $\vb*{D}_k$ stored in $\vb*{D}$}
		\State{$\vb*{U}\gets \vb*{U}_{k}$} 
		\Comment{Construct $\vb*{U}_k$ stored in $\vb*{U}$}
		\State{$\vb*{\Delta}\gets \vb*{D} - \vb*{U} \vb*{X}$} \Comment{Construct $\vb*{\Delta}_k$ stored in $\vb*{\Delta}$}
		\State{\textbf{if} $k>0$:\, Solve $\vb*{\Delta} \vb*{X}=\vb*{L}$} \Comment{Compute $\vb*{X}_{k}$ stored \qquad \qquad\qquad\qquad\qquad in $\vb*{X}$ for next iteration}
		
		\If{$k\le2$}\Comment{Save required matrices }
		\State{\textbf{if} $k=0$: $\vb*{L}_{k}\gets \vb*{L}$  	  \Comment{Save $\{\vb*{L}_k\}_{k=1}^{2}$}} 
			\State{$\vb*{U}_{k}\gets \vb*{U}$ 	\Comment{Save $\{\vb*{U}_k\}_{k=0}^{2}$  } }
		\State{$\vb*{\Delta}_{k}\gets \vb*{\Delta}$}    \Comment{Save $\{\vb*{\Delta}_k\}_{k=0}^{2}$}
		\EndIf
		\EndFor
		
		\State{}
		
		\For{$k=1$ to $0$}
		\State{Solve $\vb*{\Delta}_{k+1}\vb*{y}_1 = \vb*{\sigma}_1^{(k+1)} $} 
		
		\State{\textbf{if} $k=0$: Solve $\vb*{\Delta}_{k+1}\vb*{y}_3 = \vb*{\sigma}_3^{(k+1)} $}
		
		\State{$\vb*{\sigma}_1^{(k)} \gets \vb*{s}_1^{(k)} - \vb*{U}_k \vb*{y}_1$} \Comment{Construct $\vb*{\sigma}_1^{(k)}$ }
		\State{\textbf{if} $k=0$:  $\vb*{\sigma}_3^{(0)} \gets - \vb*{U}_0 \vb*{y}_3$} \Comment{Construct $\vb*{\sigma}_3^{(0)}$ }
		
		\EndFor
		
		
		
		\State{}
	\end{algorithmic}
	
	\textbf{2. Backward substitution:}
	\begin{algorithmic}%[1]
		\State{Solve $\vb*{\Delta}_0 \vb*{f}^{(0)} = \vb*{\sigma}^{(0)}$}
		\For{$k=1$ \textbf{to} $2$}    	
		\State{
			Solve $\vb*{\Delta}_k\vb*{f}^{(k)} = 
			\vb*{\sigma}^{(k)} - \vb*{L}_{k} \vb*{f}^{(k-1)} $
		}
		\EndFor
	\end{algorithmic}
\end{algorithm}


To summarize, the pseudocode of the implementation of the algorithm in {\MONKES} is given in Algorithm \ref{alg:MONKES_BTD}. In the first loop from $k=N_\xi-1$ to $k=0$ we construct and save $\{\vb*{L}_k,\vb*{U}_k, \vb*{\Delta}_k\}_{k=0}^{2}$ without saving any matrix from the intermediate steps nor computing any vector $\vb*{\sigma}^{(k)}$. In the second loop, the sources $\{\vb*{\sigma}_1^{(k)}\}_{k=0}^{1}$ and $\vb*{\sigma}_3^{(0)}$ are computed and saved for the posterior step of backward substitution. Finally, the backward substitution step is applied. For solving $\vb*{\Delta}_0 \vb*{f}^{(0)} = \vb*{\sigma}^{(0)}$ we have to perform the LU factorization (just for one the two source terms) and then solve for $\vb*{f}^{(0)}$. For the remaining modes, the LU factorizations of $\{\vb*{\Delta}_k\}_{k=1}^{2}$ are reused to solve for $\{\vb*{f}^{(k)}\}_{k=1}^{2}$.

Once we have solved equation (\ref{eq:DKE_Legendre_expansion_Fourier_collocation}) for $\vb*{f}^{(0)}$, $\vb*{f}^{(1)}$ and $\vb*{f}^{(2)}$, the integrals of the flux-surface average operation involved in the geometric coefficients (\ref{eq:Gamma_11_Legendre}), (\ref{eq:Gamma_31_Legendre}), (\ref{eq:Gamma_13_Legendre}) and (\ref{eq:Gamma_33_Legendre}), are conveniently computed using the trapezoidal rule, which for periodic analytic functions has geometric convergence \cite{Trapezoidal}. In section \ref{sec:Results_Benchmark} we will see that despite the cubic scaling in $N_{\text{fs}}$ of the arithmetical complexity of the algorithm, it is possible to obtain fast and accurate calculations of the monoenergetic geometric coefficients at low collisionality (and in particular $\widehat{D}_{31}$) in a single core. The reason behind this is that in the asymptotic relation $O(N_{\text{fs}}^3)\sim C_{\text{alg}} N_{\text{fs}}^3$, the constant $C_{\text{alg}}$ is small enough to allow $N_{\text{fs}}$ to take a sufficiently high value to capture accurately the spatial dependence of the distribution function without increasing much the wall-clock time. 

The algorithm is implemented in the new code {\MONKES}, written in Fortran language. The matrix inversions and multiplications are computed using the linear algebra library \texttt{LAPACK} \cite{lapack99}.